name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Testes e Validação
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
      
      - name: Configurar Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Instalar dependências
        run: npm ci
      
      - name: Configurar variáveis de ambiente
        run: |
          cp env.example .env
          echo "NODE_ENV=test" >> .env
          echo "JWT_SECRET=test_secret_key_for_ci_pipeline_123" >> .env
          echo "JWT_EXPIRES_IN=24h" >> .env
          echo "PORT=3000" >> .env
          echo "API_VERSION=v1" >> .env
      
      - name: Executar ESLint
        run: npm run lint
        continue-on-error: true
      
      - name: Executar testes unitários e E2E
        run: npm test
      
      - name: Executar validação do projeto
        run: npm run test:validate
        continue-on-error: true

  performance:
    name: Testes de Performance com K6
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Instalar dependências
        run: npm ci
      
      - name: Configurar variáveis de ambiente
        run: |
          cp env.example .env
          echo "NODE_ENV=test" >> .env
          echo "JWT_SECRET=test_secret_key_for_ci_pipeline_123" >> .env
          echo "JWT_EXPIRES_IN=24h" >> .env
          echo "PORT=3000" >> .env
          echo "API_VERSION=v1" >> .env
      
      - name: Iniciar servidor em background
        run: |
          npm start > server.log 2>&1 &
          echo $! > server.pid
          echo "Servidor iniciado em background (PID: $(cat server.pid))"
      
      - name: Aguardar servidor estar pronto
        run: |
          echo "Aguardando servidor iniciar..."
          for i in {1..30}; do
            if curl -f http://localhost:3000/health > /dev/null 2>&1; then
              echo "✅ Servidor está rodando e respondendo"
              curl http://localhost:3000/health
              exit 0
            fi
            echo "Tentativa $i/30: Servidor ainda não está pronto..."
            sleep 2
          done
          echo "❌ Servidor não iniciou a tempo"
          echo "Logs do servidor:"
          cat server.log || true
          exit 1
      
      - name: Instalar K6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
      
      - name: Executar testes de performance
        run: |
          BASE_URL=http://localhost:3000 \
          TEST_EMAIL=user@test.com \
          TEST_PASSWORD=user123 \
          ENV=ci \
          npm run test:performance
        continue-on-error: true
      
      - name: Upload relatório K6 (se existir)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-report-${{ github.run_number }}
          path: |
            k6-report.html
            summary.json
          retention-days: 30
      
      - name: Parar servidor
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) 2>/dev/null || true
            rm server.pid
          fi
          pkill -f "node src/server.js" || true
          echo "Servidor parado"

  build:
    name: Build e Validação Final
    runs-on: ubuntu-latest
    needs: [test, performance]
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Instalar dependências
        run: npm ci
      
      - name: Verificar build
        run: |
          node -c src/server.js
          echo "✅ Build validado com sucesso"
      
      - name: Auditoria de segurança
        run: npm audit --audit-level=moderate
        continue-on-error: true

